
@echo *****************************************
@echo Phase 0: Install all necessary software
@echo *****************************************
@echo 
@echo Necessary things to build this are:
@echo 
@echo git from the CLI (tick the credential manager option to avoid annoyance)
@echo https://github.com/git-for-windows/git/releases/download/v2.36.1.windows.1/Git-2.36.1-64-bit.exe
@echo 
@echo dotnet
@echo https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-6.0.301-windows-x64-installer
@echo 
@echo dotnet code gen and ef
@echo dotnet tool install -g dotnet-aspnet-codegenerator
@echo dotnet tool install --global dotnet-ef
@echo 
@echo csgen
@echo 

@echo Installing csgen in c:\SNJW\code\shared
cd c:\SNJW\code\shared
del csgen*.* /Q /F
rd csgen /S /Q
git clone https://github.com/simonnjwalker/csgen.git
cd c:\SNJW\code\shared\csgen
dotnet build
cd..
xcopy c:\SNJW\code\csgen\bin\Debug\net6.0\csgen*.* c:\SNJW\code\shared /Y /H /R
rd csgen /S /Q
@echo Finished installing csgen


@echo *****************************************
@echo Phase 1: Build MVC site
@echo *****************************************
@echo 
@echo Creating a new MVC application with Identity and Entity Framework
@echo 
@echo This will delete the folder c:\SNJW\code\xj and recreate
@echo 

cd c:\SNJW\code
rd xj /S /Q
dotnet new mvc --auth Individual --name xj
cd xj
dotnet build
xcopy c:\SNJW\code\shared\user.cs c:\SNJW\code\xj\Models /E /Y /H /R
rename c:\SNJW\code\xj\Models\user.cs xjuser.cs
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Models\xjuser.cs" "xx" "xj"

dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
xcopy c:\SNJW\code\xj\Program.cs c:\SNJW\code\xj\Areas /Y /H /R
ren c:\SNJW\code\xj\Areas\Program.cs Program.cs.txt

dotnet aspnet-codegenerator identity -dc xj.Data.ApplicationDbContext -sqlite

c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Program.cs.txt" "builder.Services.AddDefaultIdentity<IdentityUser>" "builder.Services.AddDefaultIdentity<xj.Models.xjuser>"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Data\ApplicationDbContext.cs" "public class ApplicationDbContext : IdentityDbContext" "public class ApplicationDbContext : IdentityDbContext<Models.xjuser>"
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\Views\Shared\_LoginPartial.cshtml" "<IdentityUser>" "<xj.Models.xjuser>"
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\xj.csproj" "<Nullable>enable</Nullable>" "<Nullable>disable</Nullable>"






c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ConfirmEmailChange.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ExternalLogin.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Login.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\LoginWith2fa.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\LoginWithRecoveryCode.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Logout.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Register.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\_ManageNav.cshtml" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\ChangePassword.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\DeletePersonalData.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\Email.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\ExternalLogins.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\Index.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\ResetAuthenticator.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\SetPassword.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\TwoFactorAuthentication.cshtml.cs" "IdentityUser" "xj.Models.xjuser"

c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ConfirmEmail.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ForgotPassword.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\RegisterConfirmation.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ResendEmailConfirmation.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ResetPassword.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\Disable2fa.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\DownloadPersonalData.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\EnableAuthenticator.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\GenerateRecoveryCodes.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\PersonalData.cs" "IdentityUser" "xj.Models.xjuser"

c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ConfirmEmail.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ForgotPassword.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\RegisterConfirmation.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ResendEmailConfirmation.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\ResetPassword.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\Disable2fa.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\DownloadPersonalData.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\EnableAuthenticator.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\GenerateRecoveryCodes.cshtml.cs" "IdentityUser" "xj.Models.xjuser"
c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Areas\Identity\Pages\Account\Manage\PersonalData.cshtml.cs" "IdentityUser" "xj.Models.xjuser"


c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\Areas\Identity\Pages\Account\LoginWith2fa.cshtml.cs" "using Microsoft.AspNetCore.Mvc;" "// using Microsoft.AspNetCore.Mvc;"
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\Areas\Identity\Pages\Account\LoginWith2fa.cshtml.cs" "using Microsoft.AspNetCore.Mvc.RazorPages;" "// using Microsoft.AspNetCore.Mvc.RazorPages;"




C:\SNJW\code\xj\Areas\Identity\Pages\Account\RegisterConfirmation.cshtml.cs

del c:\SNJW\code\xj\Program.cs /Q
xcopy c:\SNJW\code\xj\Areas\Program.cs.txt c:\SNJW\code\xj /Y /H /R
ren c:\SNJW\code\xj\Program.cs.txt Program.cs


dotnet build
dotnet ef migrations add SecondMigration
dotnet build
dotnet ef database update

dotnet aspnet-codegenerator controller --controllerName project -dc xj.Data.ApplicationDbContext --useSqlite --model project



dotnet ef migrations script
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\appsettings.json" "DataSource=app.db;Cache=Shared" "Data Source=app.db"
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\appsettings.Development.json" "DataSource=app.db;Cache=Shared" "Data Source=app.db"

c:\SNJW\code\shared\csgen.exe replace "c:\SNJW\code\xj\Program.cs" "    options.UseSqlServer(connectionString));builder.Services.AddDbContext<ApplicationDbContext>(options =>" ""



dotnet aspnet-codegenerator controller --controllerName country -dc HospitalContext --useSqlite --model countryvm

@echo Finished creating  new MVC application with Identity and Entity Framework


@echo hit {enter} to open VS Code now and wait until it asks you to install missing files - hit yes then close VS Code
@echo 
@echo You will need to re-open it before you hit "F5" to build
code .





@echo *****************************************
@echo 
@echo 
@echo *****************************************
@echo Phase 2: add HTML
@echo *****************************************
@echo 
@echo Started adding HTML to the site
cd c:\SNJW\code\xj
git clone https://github.com/simonnjwalker/demohtml.git
xcopy demohtml\assets wwwroot\assets /e /s /y
xcopy demohtml\index.html wwwroot /e /s /y
rd demohtml /S /Q
c:\SNJW\code\shared\csgen.exe replace "C:\SNJW\code\xj\Controllers\HomeController.cs" "return View();" "return Redirect(|index.html|);"
c:\SNJW\code\shared\csgen.exe replacewithdq "C:\SNJW\code\xj\Controllers\HomeController.cs" "|"
@echo Finished adding HTML to the site



*********************************
Prerequisites
*********************************

first check that all of the stuff is installed:
dotnet tool install -g dotnet-aspnet-codegenerator
dotnet tool install --global dotnet-ef
*********************************
second step is to download our demos
*********************************

@echo Add shared files
md c:\SNJW
md c:\SNJW\code
md c:\SNJW\code\shared
cd c:\SNJW\code
rd pubscripts /S /Q
git clone https://github.com/simonnjwalker/pubscripts.git
xcopy pubscripts\user.cs c:\SNJW\code\shared /e /s /y
xcopy pubscripts\replace.vbs c:\SNJW\code\shared /e /s /y
xcopy pubscripts\replacedq.vbs c:\SNJW\code\shared /e /s /y
rd pubscripts /S /Q








// step 2 build a new project

cd c:\SNJW\code
dotnet new mvc --auth Individual --name xj
cd xj
dotnet build
code .


{F5 to execute and follow the proxjts to install debuggers.  Then close it with SHIFT+F5}


*********************************
step 1:
create this file as: 
c:\SNJW\code\shared\user.cs
*********************************
using System.ComponentModel.DataAnnotations.Schema;
using Microsoft.AspNetCore.Identity;
namespace xx.Models;
public class xxuser : Microsoft.AspNetCore.Identity.IdentityUser
{

        public string FirstName = "";
        public string LastName = "";
}
*********************************

*********************************
step 2:
create this file as: 
c:\SNJW\code\shared\replacedq.vbs
*********************************
Const ForReading = 1
Const ForWriting = 2
strFileName = Wscript.Arguments(0)
strOldText = Wscript.Arguments(1)
strNewText = Chr(34)
Set objFSO = CreateObject("Scripting.FileSystemObject")
Set objFile = objFSO.OpenTextFile(strFileName, ForReading)
strText = objFile.ReadAll
objFile.Close
strNewText = Replace(strText, strOldText, strNewText)
Set objFile = objFSO.OpenTextFile(strFileName, ForWriting)
objFile.Write strNewText
objFile.Close
*********************************

*********************************
step 3:
create this file as: 
c:\SNJW\code\shared\replace.vbs
*********************************
Const ForReading = 1
Const ForWriting = 2

strFileName = Wscript.Arguments(0)
strOldText = Wscript.Arguments(1)
strNewText = Wscript.Arguments(2)

Set objFSO = CreateObject("Scripting.FileSystemObject")
Set objFile = objFSO.OpenTextFile(strFileName, ForReading)

strText = objFile.ReadAll
objFile.Close
strNewText = Replace(strText, strOldText, strNewText)

Set objFile = objFSO.OpenTextFile(strFileName, ForWriting)
objFile.Write strNewText
objFile.Close
*********************************

DEPRECATED:
edit the file in:
c:\SNJW\code\xj\Data\ApplicationDbContext.cs
*********************************
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
namespace xx.Data;
public class ApplicationDbContext : IdentityDbContext<Models.xjuser>
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }
}
*********************************

*********************************


// step 3 get the code gen things
dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
*********************************




//dotnet aspnet-codegenerator identity -dc xj.Models.ApplicationDbContext

If the command coxjleted without errors that should have fixed the “There was an error running the selected code generator” issue and created the necessary Identity Pages under Areas/Identity/Pages.

dotnet aspnet-codegenerator also has the ability to scaffold only specific files versus all the Identity files if you don’t need the full set by passing in the -files parameter followed by the files you want to create.


// step 4 scaffold the identity pages


dotnet aspnet-codegenerator identity -dc xj.Data.ApplicationDbContext -–files "Account._StatusMessage;Account.AccessDenied;Account.ConfirmEmail;Account.ConfirmEmailChange;Account.ExternalLogin;Account.ForgotPassword;Account.ForgotPasswordConfirmation;Account.Lockout;Account.Login;Account.LoginWith2fa;Account.LoginWithRecoveryCode;Account.Logout;Account.Manage._Layout;Account.Manage._ManageNav;Account.Manage._StatusMessage;Account.Manage.ChangePassword;Account.Manage.DeletePersonalData;Account.Manage.Disable2fa;Account.Manage.DownloadPersonalData;Account.Manage.Email;Account.Manage.EnableAuthenticator;Account.Manage.ExternalLogins;Account.Manage.GenerateRecoveryCodes;Account.Manage.Index;Account.Manage.PersonalData;Account.Manage.ResetAuthenticator;Account.Manage.SetPassword;Account.Manage.ShowRecoveryCodes;Account.Manage.TwoFactorAuthentication;Account.Register;Account.RegisterConfirmation;Account.ResendEmailConfirmation;Account.ResetPassword;Account.ResetPasswordConfirmation"




dotnet ef migrations add CreateIdentitySchema
dotnet ef database update


